<<<<<<< HEAD
sap.ui.define(["sap/m/MessageToast","sap/ui/core/util/File","sap/ui/core/Fragment","sap/ui/model/json/JSONModel"],function(e,t,a,r){"use strict";return{exportarBackup:async function(){try{let s=sap.ui.core.Element.registry.filter(function(e){return e.isA("sap.m.Table")&&e.getId().includes("Pessoa::LineItem-innerTable")});if(s.length>0){let n=s[0].getItems();if(n.length>0){let s=n[0].getBindingContext().getValue().ID;var a=this.getParent();var r=this.getParent().getParent();a.close();var o=new sap.m.Dialog({title:"Exportar Backup",type:"Message",content:new sap.m.Text({text:"Gerando backup, aguarde..."})});o.setBusy(true);o.open();let i="exportarBackup";let c=r.getModel().bindContext(`/${i}(...)`);c.setParameter("ID",s);await c.execute();let l=c.getBoundContext();let u=l.getValue("value");if(u.backup){let a=[new sap.ui.model.Filter("ID",sap.ui.model.FilterOperator.EQ,u.backup)];let s=await r.getModel().bindList(`/Backup`,null,null,a).requestContexts();if(s.length>0){let a=`${r.getModel().getServiceUrl()}Backup(ID=${u.backup})/Backup`;$.ajax({url:a,method:"GET",headers:{Accept:"application/x-zip-compressed"},xhrFields:{responseType:"blob"},success:async function(a,r,n){const i=new Uint8Array(await a.arrayBuffer());t.save(i,"backup-gestor-de-gastos","zip","application/zip");e.show("Backup exportado com sucesso!");for(let e of s){await e.delete()}o.close()},error:async function(t,a,r){for(let e of s){await e.delete()}e.show("Erro ao baixar o backup:"+r);o.close()}})}else{o.close();e.show("Erro ao baixar o backup")}}else{e.show("Erro ao exportar backup:"+u.erro);o.close()}}else{e.show("É necessário ter pelo menos um cadastro de pessoa")}}}catch(t){e.show("Erro ao exportar backup: "+t);if(o){o.close()}if(a){a.close()}}},importarBackup:async function(){try{const o=this.getParent().getParent();const s=o.getModel();const n=this.getParent();const i=a.byId("Backup","fileUploader");const c=`${s.getServiceUrl()}Backup`;const l=i.oFileUpload.files;sap.ui.core.BusyIndicator.show();if(!l||l.length===0){e.show("Por favor, selecione um arquivo.");sap.ui.core.BusyIndicator.hide();return}const u=l[0];let p=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,a=e=="x"?t:t&3|8;return a.toString(16)})};let d=async function(){return await new Promise(function(e,t){fetch(s.getServiceUrl(),{method:"GET",headers:{"X-CSRF-Token":"Fetch"}}).then(function(e){if(!e.ok){throw new Error("Erro ao obter CSRF Token")}return e}.bind(this)).then(function(e){const t=e.headers.get("X-CSRF-Token");return t}.bind(this)).then(function(t){e(t)}).catch(e=>{t(e)})}.bind(this))}.bind(this);var t={ID:p()};let g="/Backup";const h=o.getModel().bindList(`${g}`);let f=await h.create(t,false);o.getModel().attachEventOnce("dataReceived",async function(a){const o=a.getParameter("error");if(o){const a=t.parse(o.responseText||"{}");const r=a.error?.message||"Erro ao criar registro!";e.show(r);sap.ui.core.BusyIndicator.hide()}else if(f){try{const e=f.getObject();const t=new r(e);i.removeAllHeaderParameters();let a=await d();i.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"x-csrf-token",value:a}));var s=new sap.ui.unified.FileUploaderParameter({name:"If-Match",value:e["@odata.etag"]||"*"});i.insertHeaderParameter(s);var n=new sap.ui.unified.FileUploaderParameter({name:"Content-Type",value:u.type});i.insertHeaderParameter(n);var l=new sap.ui.unified.FileUploaderParameter({name:"Accept",value:"application/oBackupCreate"});i.insertHeaderParameter(l);i.setModel(t,"Backup");i.setUploadUrl(`${c}(${e.ID})/Backup`);i.setSendXHR(true);i.upload();console.log("Dados criados:",e)}catch(t){e.show("Erro desconhecido durante a importação"+t);sap.ui.core.BusyIndicator.hide()}}else{e.show("Erro desconhecido durante a importação!");sap.ui.core.BusyIndicator.hide()}}.bind(this))}catch(t){e.show("Erro ao importar o arquivo: "+t.message);e.show("Tamanho de arquivo excedido");sap.ui.core.BusyIndicator.hide()}},onUploadCompleto(t){const r=a.byId("Backup","dialogBackup");const o=this.getModel();const s=t.getParameter("responseRaw");const n=t.getParameter("status");t.getSource().setValue("");var i=a.byId("Backup","uploadProgresso");i.setPercentValue(0);i.setDisplayValue("0%");i.setVisible(false);if(n!=204){let t=JSON.parse(s);e.show(`Erro:${t.error.message}-${t.error.target}`)}else{o.refresh();let t=sap.ui.core.Element.registry.filter(function(e){return e.isA("sap.m.Table")&&e.getId().includes("innerTable")});if(t.length>0){let e=t[0];e.refreshItems()}e.show("Backup importado.")}try{var c={ID:t.getSource().getModel("Backup").getData().ID};let e=[new sap.ui.model.Filter("ID",sap.ui.model.FilterOperator.EQ,c.ID)];let a=`/Backup`;o.bindList(`${a}`,null,null,e).requestContexts().then(async function(e){if(e.length>0){for(let t of e){await t.delete()}}})}catch(e){console.log(e)}r.close();sap.ui.core.BusyIndicator.hide()},onUploadAbortado(t){const a=t.getParameter("response");if(a){var r=oBackupCreate.parse(a);e.show(r.error.message)}sap.ui.core.BusyIndicator.hide()},onModificaArquivo(e){var t=a.byId("Backup","uploadProgresso");t.setVisible(false);t.setPercentValue(0);t.setDisplayValue("0%")},onUploadProgresso(e){var t=e.getParameter("loaded");var r=e.getParameter("total");var o=Math.round(t/r*100);var s=a.byId("Backup","uploadProgresso");s.setVisible(true);s.setPercentValue(o);s.setDisplayValue(o+"%")},cancelarBackup:function(e){this.getParent().close()}}});
=======
sap.ui.define(["sap/m/MessageToast","sap/ui/core/util/File","sap/ui/core/Fragment","sap/ui/model/json/JSONModel"],function(e,t,a,o){"use strict";return{exportarBackup:async function(){var a=this.getParent();var o=this.getParent().getParent();a.close();var s=new sap.m.Dialog({title:"Exportar Backup",type:"Message",content:new sap.m.Text({text:"Gerando backup, aguarde..."})});s.setBusy(true);s.open();let r="exportarBackup";let n=o.getModel().bindContext(`/${r}(...)`);await n.execute();let i=n.getBoundContext();let c=i.getValue("value");s.close();if(c){const a=new Uint8Array(c.body.data);t.save(a,"backup-gestor-de-gastos","xlsx","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");e.show("Backup exportado com sucesso!")}else{e.show("Erro ao exportar backup!")}},importarBackup:async function(){const t=this.getParent().getParent();const o=this.getParent();const s=a.byId("Backup","fileUploader");const r=s.oFileUpload.files;sap.ui.core.BusyIndicator.show();if(!r||r.length===0){e.show("Por favor, selecione um arquivo.");sap.ui.core.BusyIndicator.hide();return}const n=r[0];const i=new FileReader;i.onload=async a=>{const s=a.target.result.split(",")[1];try{let a="importarBackup";let r=t.getModel().bindContext(`/${a}(...)`);r.setParameter("file",s);await r.execute();sap.ui.core.BusyIndicator.hide();o.setBusy(false);let n=r.getBoundContext();let i=n.getValue("value");o.close();if(i){const a=t.getModel();a.refresh();let o=sap.ui.core.Element.registry.filter(function(e){return e.isA("sap.m.Table")&&e.getId().includes("innerTable")});let s=o[0];s.refreshItems();let r=sap.ui.core.Element.registry.filter(function(e){return e.isA("sap.m.VBox")&&e.getId().includes("FaturaAtualVBox")});if(r.length){let e=r[0];e.getBindingContext().refresh()}e.show(i)}else{e.show("Erro ao importar backup!")}}catch(t){e.show("Erro ao importar o arquivo: "+t.message)}};i.readAsDataURL(n)},cancelarBackup:function(e){this.getParent().close()}}});
>>>>>>> 7f01fe1936688df1011ce89337a57e281209142a
//# sourceMappingURL=Backup.js.map